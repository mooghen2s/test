/*!
 * 
 *     MCAFEE RESTRICTED CONFIDENTIAL
 *     Copyright (c) 2024 McAfee, LLC
 *
 *     The source code contained or described herein and all documents related
 *     to the source code ("Material") are owned by McAfee or its
 *     suppliers or licensors. Title to the Material remains with McAfee
 *     or its suppliers and licensors. The Material contains trade
 *     secrets and proprietary and confidential information of McAfee or its
 *     suppliers and licensors. The Material is protected by worldwide copyright
 *     and trade secret laws and treaty provisions. No part of the Material may
 *     be used, copied, reproduced, modified, published, uploaded, posted,
 *     transmitted, distributed, or disclosed in any way without McAfee's prior
 *     express written permission.
 *
 *     No license under any patent, copyright, trade secret or other intellectual
 *     property right is granted to or conferred upon you by disclosure or
 *     delivery of the Materials, either expressly, by implication, inducement,
 *     estoppel or otherwise. Any license under such intellectual property rights
 *     must be expressed and approved by McAfee in writing.
 *
 */(()=>{"use strict";const e=0,t=0,n=1,o=2,i=3,s=4,r=1,a=2,d=3,u=4,l={BACKGROUND:"BACKGROUND",CONTENT:"CONTENT",TELEMETRY:"TELEMETRY"},c={DEFAULT:"color: #000000; font-weight: normal; font-style:normal; background: #FFFFFF;",BACKGROUND:"color: #8D0DBA; font-weight: bold; background: #FFFFFF;",CONTENT:"color: #F54A26; font-weight: bold; background: #FFFFFF;",TELEMETRY:"color: #147831; font-weight: bold; background: #FFFFFF;"};class h{static log(e,t=null){m(e,r,t)}static error(e,t=null){m(e,a,t)}static warn(e,t=null){m(e,d,t)}static debug(e,t=null){m(e,u,t)}}const m=(h,m,f)=>{const p=e;if(p===t)return;let g="chrome-extension:"===location.protocol?l.BACKGROUND:l.CONTENT;f&&l[f]&&(g=f);const w=new Date,b=m===a?h:`%c[${g} ${w.toLocaleString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}]: %c${h}`,S=c.DEFAULT;let A=c[g];if(A||(A=S),p>=o&&m===a&&console.error(h),p>=n&&m===r&&console.log(b,A,S),p>=i&&m===d){const e="color: #FFA500; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cWARN - ${b}`,e,A,S)}if(p>=s&&m===u){const e="color: #FF33D7; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cDEBUG - ${b}`,e,A,S)}},f=(e,t=null,n)=>{"function"==typeof n?chrome.runtime.onMessage.addListener(((o,i,s)=>{if(i.id===chrome.runtime.id&&"object"==typeof o&&!Array.isArray(o)&&o?.ipcId===e)return n({promises:t,request:o,sender:i,sendResponse:s})})):h.error("Provided with invalid callback function")},p=e=>{"undefined"!=typeof document&&null!==document&&("complete"===document.readyState||"loading"!==document.readyState&&!document.documentElement.doScroll?e():document.addEventListener("DOMContentLoaded",e))},g=(e=document.body,t={},n={})=>{new MutationObserver((e=>{for(const n of e){"attributes"===n.type&&t.attributeChangedCb&&t.attributeChangedCb(n.target);for(const e of n.addedNodes)t.addedNodeCb&&t.addedNodeCb(e);for(const e of n.removedNodes)t.removedNodeCb&&t.removedNodeCb(e)}})).observe(e,{childList:!0,subtree:!0,...n})},w=(e,t,n={})=>{const{add:o=!1,remove:i=!1}=n;if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n+=1){if(t[n].node.isSameNode(e))return i&&t.splice(n,1),!0}return o&&t.push({node:e,url:window.location.href}),!1},b=()=>{const e=new Uint8Array(24);crypto.getRandomValues(e);let t=Date.now().toString()+Math.random().toString().substring(2);for(let n=0;n<24;++n)t+=e[n].toString();let n="";for(let e=0;e<36;++e)if(8===e||13===e||18===e||23===e)n+="-";else{n+=t[Math.floor(Math.random()*t.length)]}return`{${n}}`};class S{constructor(e,t){this.pingCommand=e,this.ipcId=t,this.mainFunction="function"==typeof this.main?((e,t)=>{let n;return(...o)=>(e&&(n=e.apply(t||void 0,o),e=null,t=null),n)})(this.main,this):()=>{},this.basePingListener(),this.addIdentifier()}basePingListener(){f(this.ipcId,null,(({request:e,sendResponse:t})=>{const{command:n,...o}=e;if(n===this.pingCommand)return h.debug(`File Injection [pinged]: Received ${n} command`),t({content:!0}),"function"==typeof this.mainFunction&&this.mainFunction(o),"function"==typeof this.callback&&this.callback(),!0}))}addIdentifier(){p((()=>{const e=document.createElement("span");e.id=this.pingCommand,e.style.cssText="display:none",document.body.appendChild(e)}))}}const A=async(e,t,n,o)=>{try{E(e,t,n,o)}catch(e){h.warn(`[broadcast] Unexpected error when calling command: "${t}", err: ${e.message}`)}},E=(e,t,n,o,i=null)=>{if(!chrome.tabs)throw new Error('"tabs" permission not set in manifest.');return chrome.tabs.sendMessage(o,{ipcId:e,command:t,...n},{frameId:i})},v="MC_SHADOW_ADDED",M="MC_SHADOW_PROCESSED",y="MC_CONTENT_SCRIPT_INITIALIZED",R="MB",k=1,C=(e,t={},n)=>(async(e,t,n={},o={})=>{try{if(o?.tabId){const{tabId:i,frameId:s}=o;return await E(e,t,n,i,s)}if(o?.broadcast){const i=await chrome.tabs.query({}),{broadcastIgnoreId:s=[]}=o;return i.filter((({id:e})=>!s.includes(e))).forEach((({id:o})=>{A(e,t,n,o)})),!0}return await chrome.runtime.sendMessage({ipcId:e,command:t,...n})}catch(e){return h.warn(`Unexpected error when calling command: "${t}", err: ${e.message}`),null}})(R,e,t,n),N="NATIVE_STREAM",T="CAPTURE_WITH_PERMISSION",F="AUDIO_NODE_REMOVED",I="MB_SEND_VIDEO_ENDED_EVENT_TO_WA",P="GET_SOCKET_DETAILS",D="PROMPT_PERMISSION_AND_STREAM",L="MB_ENABLEMENT_STATE",_="PING_CONTENT_MB_MAIN";class O{constructor(){this.audioInfos=[]}add(e){const t={id:b(),element:e,recorder:null,websocket:null,listening:!1,capturing:!1,permissionRequired:!1,tabStream:null,canvas:null,src:null,workletNodePort:null};return this.audioInfos.push(t),t}get(e){for(const t of this.audioInfos)if(t.element.isSameNode(e))return t;return null}getById(e){for(const t of this.audioInfos)if(t.id===e)return t;return null}}class U{constructor(e,t){this.featureEnabled=e,this.secret=t.secret,this.port=t.port,this.samplerate=t.settings.samplerate,this.chunksize=t.settings.chunksize,this.uniqueMessageId=t.uniqueMessageId,this.windowid=t.windowid,this.tabid=t.tabid,this.frameid=t.frameid,this.workletUrl=t.workletUrl,this.socketUri=`ws://127.0.0.1:${this.port}/`,this.version=1,window.audioMonitor=new O}handleAudioFound(e,t){[...e,...t].forEach((e=>this.monitorElement(e)))}handleAudioRemoved(e,t){[...e,...t].forEach((e=>{const t=window?.audioMonitor.get(e)||null;if(t){const e={tabId:this.tabid,frameId:this.frameid,id:t.id};C(F,{payload:e})}}))}monitorElement(e){let t=window.audioMonitor.get(e);t||(t=window.audioMonitor.add(e),t.listening=!1),t.listening||this.addListeners(t),this.isPlayingAndAudible(e)&&(t.listener="monitorElement",this.startStream(t))}addListeners(e){e.isListening=!0;const{element:t}=e;["play","playing"].forEach((n=>{t.addEventListener(n,(()=>{this.isMuted(t)||(e.listener=n,this.startStream(e))}))})),["pause","stalled","ended","error","abort"].forEach((n=>{t.addEventListener(n,(()=>{e.listener=n,this.stopStream(e)}))})),t.addEventListener("ended",(e=>{C(I,{videoSrc:e.target.src})})),t.addEventListener("volumechange",(()=>{e.listener="volumechange",this.isPlayingAndAudible(t)?this.startStream(e):this.stopStream(e)})),t.addEventListener("loadeddata",(async()=>{await this.waitforUpto(500,3,(()=>this.isPlayingAndAudible(t)))&&(e.listener="loadeddata",this.startStream(e))}))}isPlayingAndAudible(e){return!(!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2)||this.isMuted(e))}isMuted(e){return e.muted}waitforUpto(e,t,n){const o=(t,i)=>{n()?i(!0):(t||i(!1),setTimeout((()=>{o(t--,i)}),e))};return new Promise((e=>{o(t,e)}))}handShakeWebSocket(e){const{id:t,element:n}=e,o={version:this.version,topurl:document.location.href,secretcode:this.secret,frameid:this.frameid,tabid:this.tabid,windowid:this.windowid,defsamplerate:e.defaultSampleRate,defchannels:e.defaultChannels,id:t,srcurl:n.currentSrc||""};e.websocket.send(JSON.stringify(o))}async startStream(e){if(!this.featureEnabled)return h.log("[MB:startStream] feature not enabled"),!1;h.log("startStream called with monitoring object:"),h.log(JSON.stringify(e)),e.url=window.location.href;const t=e.element.src||e.element.currentSrc;e.src?e.src!==t&&this.stopStream(e):e.src=t;const{element:n,capturing:o,permissionRequired:i,tabStream:s,id:r}=e;if(o||i&&!s)return!0;let a=null;try{a=s||(n.captureStream?n.captureStream():n.mozCaptureStream()),e.capturing=!0}catch(t){h.warn(`Failed to capture stream error: ${t.message}`);const{state:n}=await(navigator?.permissions?.query({name:"microphone"}))||{};if(!n)return h.warn('Failed to request permission due to unsupported api "navigator.permissions"'),!1;switch(n){case"granted":return this.promptPermissionAndStream(r),!0;case"prompt":return this.stopStream(e),this.captureStreamWithPermission(e),!0;case"denied":return h.warn("User has denied permission, unable to prompt and record audio."),!1;default:return h.warn(`navigator.permissions returned unsupported state, state='${n}'`),!1}}if(!n.captureStream){const e=new AudioContext;e.createMediaStreamSource(a).connect(e.destination)}if(!a)return this.stopStream(e),!1;const d=await this.getAudioTracks(a);if(!d||d.length<=0)return this.stopStream(e),!1;const u=new AudioContext({sampleRate:this.samplerate});e.defaultSampleRate=u.sampleRate,e.defaultChannels=1;try{await u.audioWorklet.addModule(this.workletUrl);const t=u.createMediaStreamSource(a),n=new AudioWorkletNode(u,"pcm-processor");t.connect(n),e.workletNodePort=n.port,e.workletNodePort.onmessage=({data:t})=>{if(this.featureEnabled){if((e.capturing||t.isLast)&&t.buffer&&t.buffer.length>0){const n=new Float32Array(t.buffer),o=new Blob([n.buffer],{type:"audio/pcm"});e.totalSend+=o.size,e.streamId++,e.websocket&&e.websocket.readyState===k?this.streamWebSocket(e,o,t.isLast):this.streamNativeMessage(e,o,t.isLast)}}else this.stopStream(e)}}catch(t){return h.warn(`Failed to initialize audioWorklet, err: ${t.message}`),this.stopStream(e),!1}if(!e.defaultSampleRate||!e.defaultChannels)return this.stopStream(e),!1;if(e.streamId=0,e.totalSend=0,!this.port)return e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize}),!0;try{await this.startWebSocket(e)}catch(t){h.error(`Failed to connect through websocket, defaulting to fallback messaging, err: ${t.message}`),e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize})}return!0}stopStream(e){if(h.log("stopStream called with monitoring object:"),h.log(JSON.stringify(e)),!e.permissionRequired&&(e.workletNodePort&&(e.workletNodePort.postMessage({state:"stop"}),e.workletNodePort=null),e.websocket&&(e.websocket?.close(),e.websocket=null),e.capturing=!1,e.src=null,"abort"===e.listener&&e.url!==window.location.href)){if(!this.featureEnabled)return;this.handleAudioRemoved([e.element],[])}}async getAudioTracks(e){const t=e=>{const t=e.getAudioTracks();return!t||t.length<=0?null:t};return new Promise((n=>{const o=t(e);o?n(o):setTimeout((()=>n(t(e))),500)}))}async startWebSocket(e){return new Promise(((t,n)=>{const o=new WebSocket(this.socketUri);o.onopen=()=>{e.websocket=o,this.handShakeWebSocket(e),e.workletNodePort&&e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize}),t()},o.onerror=t=>{h.error(`Websocket error: ${t.message}`),e.listener="onerror",e.websocket=null,n(t)},o.onclose=()=>{h.log("Websocket closed")}}))}streamWebSocket(e,t,n){const{element:o,id:i}=e,s={id:i,islastchunk:n||!1,srcurl:o.currentSrc??"",curtime:o.currentTime??-1,muted:o.muted??null,duration:o.duration??-1,browserurllocale:navigator.language,defsamplerate:e.defaultSampleRate,defchannels:e.defaultChannels,streamid:e.streamId};e.websocket.send(JSON.stringify(s)),e.websocket.send(t),h.log(`Sending : ${t.size} Buffered : ${e.websocket.bufferedAmount} total : ${e.totalSend} streamid: ${e.streamId}`)}streamNativeMessage(e,t,n){const o=new window.FileReader;o.readAsDataURL(t),o.onloadend=()=>{const{element:t,id:i}=e,s=o.result,r={id:i,version:this.version,islastchunk:n||!1,topurl:document.location.href,srcurl:t.currentSrc??"",curtime:t.currentTime??-1,muted:t.muted??null,duration:t.duration??-1,tabid:this.tabid,frameid:this.frameId,windowid:this.windowid,data64:s,data:"",browserurllocale:navigator.language,defsamplerate:e.defaultSampleRate,defchannels:e.defaultChannels,streamid:e.streamId};C(N,{payload:r})}}captureStreamWithPermission(e){if(navigator?.mediaDevice)return void h.warn("Unable to captureStreamWithPermission since navigator.mediaDevices is undefined");e.permissionRequired=!0;const{element:t,id:n}=e,o={id:n,topurl:document.location.href,frameurl:t.ownerDocument?.location?.href||"",srcurl:t.currentSrc??"",tabid:this.tabid,frameid:this.frameid,permissionRequired:!0};C(T,{payload:o})}async promptPermissionAndStream(e){try{const t=await(navigator?.mediaDevices?.getUserMedia({video:!1,audio:!0}));if(!t)return;const n=window.audioMonitor.getById(e);n.tabStream=t,n.permissionRequired=!1,this.isPlayingAndAudible(n.element)&&this.startStream(n)}catch(e){h.warn(`promptPermissionAndStream err, ${e.message}`)}}handleCanvasFound(e){e.forEach((e=>this.attachCanvasListener(e)))}attachCanvasListener(e){let t=window.audioMonitor.get(e);t||(t=window.audioMonitor.add(e),t.listening=!1),t.listening||(e.addEventListener(this.uniqueMessageId,(({detail:e={}})=>{"MB_PROCESS_CANVAS"===e.command&&this.handleCanvasListener(e,t)})),t.listening=!0)}handleCanvasListener(e,t){const{event:n="",id:o,data:i}=e;"ATTACHED_ID"===n?t.id=o:"CAPTURE_START"===n?t.capturing=!0:"CAPTURE_STOP"===n?t.capturing=!1:"NATIVE_STREAM"===n?C(N,{payload:i}):"VIDEO_REMOVED"===n&&this.handleAudioRemoved([t.element],[])}stopProcessingAudio(){(window.audioMonitor.audioInfos||[]).forEach((e=>{this.stopStream(e)}))}}class ${constructor(e,t={}){this.uniqueMessageId=e,this.type={video:"video",canvas:"canvas"},this.onAudioFound=null,this.onAudioRemoved=null,this.onCanvasFound=null;const{video:n=!0,canvas:o=!0}=t;this.supported=[],n&&this.supported.push(this.type.video),o&&this.supported.push(this.type.canvas),this.processedElements=[]}init(){if("function"!=typeof this.onAudioFound||"function"!=typeof this.onAudioRemoved)return void h.error("Please provide a callback function (onAudioFound / onAudioRemoved)");this.processDom(document.body),h.log(`[MB:AudioRetriever] requesting initial shadow for id: ${this.uniqueMessageId}`);const e=new CustomEvent(this.uniqueMessageId,{detail:{command:y}});document.dispatchEvent(e)}processDom(e){g(e,{addedNodeCb:this.handleAddedMutation.bind(this),removedNodeCb:this.handleRemovedMutation.bind(this)}),g(e,{attributeChangedCb:this.handleAttributeMutation.bind(this)},{attributeFilter:["src"]});const t=this.findAudioElements(e);(t.video.length>0||t.audio.length>0)&&this.onAudioFound(t),t.canvas.length>0&&this.onCanvasFound(t.canvas)}findAudioElements(e){const t={video:[],audio:[],canvas:[]},n=e=>e instanceof HTMLMediaElement&&!w(e,this.processedElements,{add:!0})?(t.video.push(e),!0):e instanceof HTMLAudioElement&&!w(e,this.processedElements,{add:!0})?(t.audio.push(e),!0):e instanceof HTMLCanvasElement&&!w(e,this.processedElements,{add:!0})&&(t.canvas.push(e),!0);if(!n(e)&&e?.querySelectorAll){const t=this.supported.join(","),o=e?.querySelectorAll(t)||[];Array.from(o).forEach((e=>n(e)))}return t}handleAddedMutation(e){if(e?.id===v){const{parentNode:t}=e;if(e.remove(),!t||t.getAttribute(M))return;t.setAttribute(M,"true");const n=this.getShadowRoot(t);n&&this.processDom(n)}else{const t=this.findAudioElements(e);(t.video.length>0||t.audio.length>0)&&this.onAudioFound&&this.onAudioFound(t),t.canvas.length>0&&this.onCanvasFound&&this.onCanvasFound(t.canvas)}}handleRemovedMutation(e){const t={video:[],audio:[]};if(e instanceof HTMLMediaElement&&w(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.video.push(e)}if(e instanceof HTMLAudioElement&&w(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.audio.push(e)}(t.video.length>0||t.audio.length>0)&&this.onAudioRemoved&&this.onAudioRemoved(t)}handleAttributeMutation(e){if(e.getAttribute("src")&&0!==e.offsetWidth&&0!==e.offsetHeight||this.handleRemovedMutation(e),e instanceof HTMLMediaElement&&w(e,this.processedElements)&&0===e.buffered.length){const t=((e,t)=>{if(!Array.isArray(t))return"";for(let n=0;n<t.length;n+=1)if(t[n].node.isSameNode(e))return t[n].url;return""})(e,this.processedElements);t!==window.location.href&&this.handleRemovedMutation(e)}}getShadowRoot(e){try{return chrome.dom?.openOrClosedShadowRoot(e)||e?.openOrClosedShadowRoot||null}catch(e){return null}}}class q{constructor(){this.audioProcessor=null,this.featureEnabled=!0}init(e){this.initListeners(),this.initAudioHandlers(e)}initAudioHandlers(e){this.audioProcessor=new U(this.featureEnabled,e);const t=new $(e.uniqueMessageId);t.onAudioFound=({video:e,audio:t})=>this.audioProcessor.handleAudioFound(e,t),t.onAudioRemoved=({video:e,audio:t})=>this.audioProcessor.handleAudioRemoved(e,t),t.onCanvasFound=e=>this.audioProcessor.handleCanvasFound(e),t.init()}initListeners(){f(R,null,(async({request:e,sendResponse:t})=>{const{command:n,elementId:o}=e;if(n===D)return this.audioProcessor.promptPermissionAndStream(o),t(!0),!0;if(n===L){if(this.featureEnabled=e.enabled,this.featureEnabled){const e=await C(P);this.initAudioHandlers(e)}else this.audioProcessor.stopProcessingAudio();return t({content:!0}),!0}}))}}(new class extends S{constructor(){super(_,R)}async start(){const e=await C(P);p((()=>{(new q).init(e)}))}}).start()})();
//# sourceMappingURL=../../sourceMap/chrome/MockingBird-Package/scripts/mockingbird_content_main.js.map